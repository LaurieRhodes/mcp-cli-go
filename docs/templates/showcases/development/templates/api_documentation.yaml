name: api_documentation
description: Auto-generate OpenAPI specification from API codebase
version: 1.0.0
author: Development Templates
tags: [development, api, documentation, openapi, automation]

config:
  defaults:
    provider: anthropic
    model: claude-3-5-sonnet
    temperature: 0.2
    max_tokens: 8000

steps:
  # Step 1: Extract API endpoints from codebase
  - name: extract_endpoints
    prompt: |
      Analyze this {{input_data.framework | default: 'REST'}} API codebase and extract all endpoints:
      
      **Codebase:**
      {{input_data.codebase}}
      
      **Framework:** {{input_data.framework | default: 'fastapi|flask|express|django'}}
      
      For each endpoint, extract:
      
      **Route Information:**
      - HTTP method (GET, POST, PUT, PATCH, DELETE, OPTIONS, HEAD)
      - Route path (/api/users, /api/users/{id}, etc.)
      - Path parameters (e.g., {id}, {user_id})
      - Query parameters
      
      **Handler Information:**
      - Function name
      - File location
      - Line number
      - Decorators/annotations
      
      **Authentication:**
      - Authentication required? (look for @auth decorators, middleware)
      - Authorization roles/permissions
      
      Return structured JSON:
      ```json
      {
        "endpoints": [
          {
            "method": "GET",
            "path": "/api/users",
            "handler": "list_users",
            "file": "api/users.py",
            "line": 42,
            "auth_required": true,
            "roles": ["admin", "user"]
          },
          {
            "method": "POST",
            "path": "/api/users",
            "handler": "create_user",
            "file": "api/users.py",
            "line": 68,
            "auth_required": true,
            "roles": ["admin"]
          }
        ],
        "summary": {
          "total_endpoints": 25,
          "by_method": {"GET": 10, "POST": 8, "PUT": 5, "DELETE": 2},
          "authenticated": 20,
          "public": 5
        }
      }
      ```
      
      Be comprehensive - find ALL endpoints in the codebase.
    output: endpoints

  # Step 2: Extract request/response schemas for each endpoint
  - name: extract_schemas
    prompt: |
      For each endpoint, extract request and response schemas:
      
      **Endpoints:**
      {{endpoints}}
      
      **Task:** Analyze handler functions to determine:
      
      ## Request Schema
      
      **Content-Type:**
      - application/json (most common)
      - multipart/form-data (file uploads)
      - application/x-www-form-urlencoded
      
      **Request Body Structure:**
      - Look for Pydantic models (FastAPI)
      - Look for request.json usage (Flask)
      - Look for body parameter types (TypeScript)
      - Identify required vs optional fields
      - Determine field types (string, integer, boolean, array, object)
      - Extract validation rules (min, max, pattern, format)
      
      ## Response Schema
      
      **Status Codes:**
      - Success codes (200, 201, 204)
      - Client error codes (400, 401, 403, 404, 422)
      - Server error codes (500, 502, 503)
      
      **Response Body:**
      - Success response structure
      - Error response structure
      - Field types and descriptions
      
      ## Example Discovery
      
      - Look for test files that call this endpoint
      - Extract example request/response from tests
      - If no tests: Generate realistic example
      
      Return OpenAPI-compatible schemas:
      ```json
      {
        "schemas": [
          {
            "endpoint": "POST /api/users",
            "request": {
              "content_type": "application/json",
              "schema": {
                "type": "object",
                "required": ["name", "email"],
                "properties": {
                  "name": {"type": "string", "minLength": 1},
                  "email": {"type": "string", "format": "email"},
                  "age": {"type": "integer", "minimum": 0}
                }
              },
              "example": {
                "name": "John Doe",
                "email": "john@example.com",
                "age": 30
              }
            },
            "responses": {
              "201": {
                "description": "User created successfully",
                "schema": {
                  "type": "object",
                  "properties": {
                    "id": {"type": "integer"},
                    "name": {"type": "string"},
                    "email": {"type": "string"},
                    "created_at": {"type": "string", "format": "date-time"}
                  }
                },
                "example": {
                  "id": 123,
                  "name": "John Doe",
                  "email": "john@example.com",
                  "created_at": "2024-12-28T10:00:00Z"
                }
              },
              "400": {
                "description": "Invalid request",
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {"type": "string"},
                    "details": {"type": "object"}
                  }
                }
              }
            }
          }
        ]
      }
      ```
    output: schemas

  # Step 3: Extract descriptions from code comments/docstrings
  - name: extract_descriptions
    prompt: |
      Extract endpoint descriptions from code:
      
      **Endpoints:**
      {{endpoints}}
      
      For each endpoint:
      
      ## From Docstrings/Comments
      
      Look for:
      - Function docstrings
      - Inline comments
      - Decorator descriptions
      - OpenAPI annotations (if already present)
      
      Extract:
      - Summary (one-line description)
      - Detailed description (paragraph)
      - Parameter descriptions
      - Return value description
      - Example usage
      - Notes/warnings
      
      ## Auto-Generate if Missing
      
      If no documentation found, generate sensible descriptions:
      - Based on function name (create_user â†’ "Create a new user")
      - Based on HTTP method and path
      - Based on request/response types
      
      Return descriptions:
      ```json
      {
        "descriptions": [
          {
            "endpoint": "POST /api/users",
            "summary": "Create new user",
            "description": "Creates a new user account with the provided information. Email must be unique.",
            "parameters": {
              "name": "User's full name",
              "email": "User's email address (must be unique)",
              "age": "User's age in years (optional)"
            },
            "source": "docstring" // or "generated"
          }
        ]
      }
      ```
    output: descriptions

  # Step 4: Generate complete OpenAPI 3.0 specification
  - name: generate_openapi
    prompt: |
      Generate complete OpenAPI 3.0 specification:
      
      **API Information:**
      - Title: {{input_data.api_title | default: 'API Documentation'}}
      - Version: {{input_data.api_version | default: '1.0.0'}}
      - Description: {{input_data.api_description | default: 'Auto-generated API documentation'}}
      - Server URL: {{input_data.server_url | default: 'http://localhost:8000'}}
      
      **Endpoints:** {{endpoints}}
      **Schemas:** {{schemas}}
      **Descriptions:** {{descriptions}}
      
      Create OpenAPI 3.0 YAML specification:
      
      ```yaml
      openapi: 3.0.0
      info:
        title: {{api_title}}
        version: {{api_version}}
        description: {{api_description}}
        contact:
          name: {{contact_name | default: 'API Team'}}
          email: {{contact_email}}
      
      servers:
        - url: {{server_url}}
          description: {{server_description | default: 'Production server'}}
      
      paths:
        # Generate for each endpoint
        /api/users:
          get:
            summary: List users
            description: Returns paginated list of users
            tags:
              - Users
            security:
              - bearerAuth: []
            parameters:
              - name: page
                in: query
                schema:
                  type: integer
                  default: 1
              - name: limit
                in: query
                schema:
                  type: integer
                  default: 20
            responses:
              '200':
                description: Successful response
                content:
                  application/json:
                    schema:
                      type: object
                      properties:
                        users:
                          type: array
                          items:
                            $ref: '#/components/schemas/User'
                        total:
                          type: integer
                    example:
                      users: [...]
                      total: 150
          
          post:
            summary: Create user
            description: Creates new user account
            tags:
              - Users
            security:
              - bearerAuth: []
            requestBody:
              required: true
              content:
                application/json:
                  schema:
                    $ref: '#/components/schemas/CreateUserRequest'
                  example:
                    name: "John Doe"
                    email: "john@example.com"
            responses:
              '201':
                description: User created
                content:
                  application/json:
                    schema:
                      $ref: '#/components/schemas/User'
              '400':
                description: Invalid input
                content:
                  application/json:
                    schema:
                      $ref: '#/components/schemas/Error'
      
      components:
        schemas:
          # Extract common schemas and reference them
          User:
            type: object
            properties:
              id:
                type: integer
              name:
                type: string
              email:
                type: string
                format: email
          
          CreateUserRequest:
            type: object
            required:
              - name
              - email
            properties:
              name:
                type: string
              email:
                type: string
                format: email
          
          Error:
            type: object
            properties:
              error:
                type: string
              message:
                type: string
        
        securitySchemes:
          bearerAuth:
            type: http
            scheme: bearer
            bearerFormat: JWT
      
      tags:
        - name: Users
          description: User management endpoints
      ```
      
      Follow OpenAPI 3.0 specification strictly.
      Use $ref for schema reuse to keep spec DRY.
      Include realistic examples for every endpoint.
    output: openapi_spec

  # Step 5: Validate generated specification
  - name: validate_spec
    prompt: |
      Validate the generated OpenAPI specification:
      
      **Generated Spec:**
      {{openapi_spec}}
      
      **Original Endpoints:**
      {{endpoints}}
      
      Check:
      
      ## Completeness (100% required)
      - All endpoints from code are documented?
      - All path/query parameters included?
      - All request/response status codes covered?
      - All schemas properly defined?
      
      ## Accuracy
      - Types match code types?
      - Required fields match code validation?
      - Paths exactly match route definitions?
      - Authentication requirements correct?
      
      ## OpenAPI Compliance
      - Valid OpenAPI 3.0 syntax?
      - All $ref references resolve?
      - No duplicate operationIds?
      - Proper use of components/schemas?
      
      ## Quality
      - Descriptions present and helpful?
      - Examples included?
      - Consistent naming?
      - Follows REST conventions?
      
      Return validation report:
      ```json
      {
        "valid": true,
        "completeness": "100%",
        "endpoints_documented": 25,
        "endpoints_total": 25,
        "issues": [],
        "warnings": [
          "GET /api/users/{id} missing example response",
          "POST /api/login should use 200 not 201"
        ],
        "recommendations": [
          "Add pagination to /api/posts endpoint",
          "Consider versioning API (add /v1/ prefix)"
        ]
      }
      ```
    output: validation

  # Step 6: Generate documentation report
  - name: generate_report
    prompt: |
      # API Documentation Generation Report
      
      **API:** {{input_data.api_title | default: 'API'}} v{{input_data.api_version | default: '1.0.0'}}
      **Generated:** {{execution.timestamp}}
      **Template:** {{template.name}} v{{template.version}}
      
      ---
      
      ## Summary
      
      **Endpoints Documented:** {{validation.endpoints_documented}} / {{validation.endpoints_total}}
      **Completeness:** {{validation.completeness}}
      **Validation:** {% if validation.valid %}âœ“ PASSED{% else %}âŒ FAILED{% endif %}
      
      **OpenAPI Version:** 3.0.0
      **Spec Size:** {{openapi_spec.length}} characters
      
      ---
      
      ## Endpoints Overview
      
      **Total:** {{endpoints.summary.total_endpoints}}
      
      **By Method:**
      {{#each endpoints.summary.by_method}}
      - {{@key}}: {{this}}
      {{/each}}
      
      **Authentication:**
      - Authenticated endpoints: {{endpoints.summary.authenticated}}
      - Public endpoints: {{endpoints.summary.public}}
      
      ---
      
      ## Endpoint Details
      
      {{#each endpoints.endpoints}}
      ### {{this.method}} {{this.path}}
      
      **Handler:** `{{this.handler}}` ({{this.file}}:{{this.line}})
      **Auth Required:** {% if this.auth_required %}Yes{% else %}No{% endif %}
      {% if this.roles %}**Roles:** {{this.roles}}{% endif %}
      
      **Description:**
      {{lookup descriptions.descriptions @index 'summary'}}
      
      ---
      {{/each}}
      
      ---
      
      ## Schema Components
      
      **Reusable Schemas:** {{schemas.components_count}}
      
      Common types extracted:
      {{#each schemas.common_schemas}}
      - {{this.name}}: {{this.description}}
      {{/each}}
      
      ---
      
      ## Validation Results
      
      **Status:** {% if validation.valid %}âœ“ VALID{% else %}âŒ INVALID{% endif %}
      
      {% if validation.issues.length > 0 %}
      **Issues (Must Fix):**
      {{#each validation.issues}}
      - âŒ {{this}}
      {{/each}}
      {% endif %}
      
      {% if validation.warnings.length > 0 %}
      **Warnings (Should Fix):**
      {{#each validation.warnings}}
      - âš ï¸ {{this}}
      {{/each}}
      {% endif %}
      
      {% if validation.recommendations.length > 0 %}
      **Recommendations:**
      {{#each validation.recommendations}}
      - ðŸ’¡ {{this}}
      {{/each}}
      {% endif %}
      
      ---
      
      ## Generated Files
      
      **OpenAPI Specification:**
      - File: `{{input_data.output_file | default: 'api-spec.yaml'}}`
      - Format: YAML (OpenAPI 3.0)
      - Size: {{openapi_spec.length}} characters
      
      ---
      
      ## Next Steps
      
      1. **Review Generated Spec:**
         - Check endpoint descriptions
         - Verify examples are realistic
         - Add missing business context
      
      2. **Host Documentation:**
         ```bash
         # Using Swagger UI
         docker run -p 8080:8080 \\
           -e SWAGGER_JSON=/api-spec.yaml \\
           -v $(pwd):/usr/share/nginx/html/api \\
           swaggerapi/swagger-ui
         ```
      
      3. **Generate Client SDKs:**
         ```bash
         # Python client
         openapi-generator generate -i api-spec.yaml -g python \\
           -o clients/python
         
         # TypeScript client
         openapi-generator generate -i api-spec.yaml -g typescript-fetch \\
           -o clients/typescript
         
         # Go client
         openapi-generator generate -i api-spec.yaml -g go \\
           -o clients/go
         ```
      
      4. **Validate Spec:**
         ```bash
         # Using Swagger CLI
         npx @apidevtools/swagger-cli validate api-spec.yaml
         
         # Using OpenAPI Generator
         openapi-generator validate -i api-spec.yaml
         ```
      
      5. **Automate in CI/CD:**
         - Run template on every merge to main
         - Auto-commit updated spec
         - Deploy docs automatically
      
      ---
      
      **Documentation Status:** {% if validation.completeness == '100%' %}âœ“ Complete{% else %}âš ï¸ Incomplete ({{validation.completeness}}){% endif %}
      **Manual Review:** {% if validation.warnings.length > 0 %}Recommended{% else %}Optional{% endif %}
      
      **Generated by:** {{template.name}} v{{template.version}}
