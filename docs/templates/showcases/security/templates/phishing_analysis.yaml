name: phishing_analysis
description: Automated phishing email analysis and incident creation
version: 1.0.0
author: Security Templates
tags: [security, phishing, email, incident-response]

config:
  defaults:
    provider: anthropic
    model: claude-3-5-sonnet
    temperature: 0.2
    max_tokens: 5000

steps:
  # Step 1: Extract email components
  - name: extract_email_data
    prompt: |
      Analyze this email for phishing indicators:
      
      {{input_data.email}}
      
      Extract:
      
      **Headers:**
      - From address (display name vs actual email)
      - Reply-to address (if different from From)
      - Return-path
      - Received headers (email path)
      - SPF/DKIM/DMARC results
      
      **Content:**
      - Subject line
      - Body text
      - URLs (all links, including hidden ones)
      - Attachments (names, types, hashes if available)
      
      **Metadata:**
      - Timestamp
      - Recipient(s)
      - Email client/server
      
      Return structured extraction.
    output: email_data

  # Step 2: Analyze phishing indicators
  - name: phishing_indicators
    prompt: |
      Analyze email for phishing indicators:
      
      **Email Data:**
      {{email_data}}
      
      **Check for:**
      
      1. **Sender Spoofing:**
         - Display name mismatch with email address?
         - Domain typosquatting (paypa1.com vs paypal.com)?
         - Reply-to different from sender?
         - Free email service for business communication?
      
      2. **Urgency/Pressure Tactics:**
         - "Urgent action required"
         - "Account will be suspended"
         - "Verify within 24 hours"
         - "Limited time offer"
      
      3. **Suspicious Links:**
         - URL mismatch (text says paypal.com, link goes elsewhere)
         - Shortened URLs hiding destination
         - Suspicious domains
         - Multiple redirects
         - IP addresses instead of domains
      
      4. **Attachments:**
         - Executable files (.exe, .scr, .bat)
         - Macro-enabled documents (.docm, .xlsm)
         - Compressed files hiding content
         - Password-protected archives
      
      5. **Social Engineering:**
         - Requests for credentials
         - Asks to bypass security
         - Unusual requests from "executives"
         - Grammar/spelling errors
      
      6. **Authentication Failures:**
         - SPF failure
         - DKIM failure
         - DMARC failure
      
      Score each category (HIGH/MEDIUM/LOW/NONE risk).
      Return comprehensive indicator analysis.
    output: indicators

  # Step 3: Check IOCs against threat intel
  - name: ioc_reputation
    prompt: |
      Check IOC reputation:
      
      **URLs found:**
      {{email_data.urls}}
      
      **Domains:**
      {{email_data.domains}}
      
      **Sender IP:**
      {{email_data.sender_ip}}
      
      **Attachments:**
      {{email_data.attachments}}
      
      Assess:
      - Known phishing URLs/domains?
      - Recently registered domains?
      - Sender IP reputation
      - File hash reputation (if available)
      - Historical phishing campaigns
      
      Note: In production, this would query VirusTotal, URLhaus, etc.
      Provide threat intelligence assessment based on indicators.
    output: threat_intel

  # Step 4: Determine if phishing
  - name: phishing_verdict
    prompt: |
      Final phishing determination:
      
      **Email:**
      {{email_data}}
      
      **Indicators:**
      {{indicators}}
      
      **Threat Intel:**
      {{threat_intel}}
      
      **Verdict:**
      
      Classify as:
      - CONFIRMED_PHISHING: Clear phishing attempt
      - LIKELY_PHISHING: Strong indicators, probably phishing
      - SUSPICIOUS: Some red flags, needs investigation
      - LIKELY_SAFE: Appears legitimate but minor concerns
      - SAFE: Legitimate email, false alarm
      
      **Confidence:** HIGH/MEDIUM/LOW
      
      **Reasoning:**
      Explain the decision with specific evidence
      
      **Risk Level:**
      CRITICAL/HIGH/MEDIUM/LOW
      
      **Recommended Action:**
      - Block sender/domain
      - Quarantine similar emails
      - Alert recipients
      - Create security incident
      - User education opportunity
      - Close as safe
      
      Return structured verdict.
    output: verdict

  # Step 5: Generate incident report
  - name: generate_report
    prompt: |
      # Phishing Analysis Report
      
      **Email ID:** {{input_data.email_id}}
      **Analyzed:** {{execution.timestamp}}
      
      ## Verdict
      
      **Classification:** {{verdict.classification}}
      **Confidence:** {{verdict.confidence}}
      **Risk Level:** {{verdict.risk_level}}
      
      ## Summary
      
      {{verdict.reasoning}}
      
      ## Email Details
      
      **From:** {{email_data.from}}
      **Subject:** {{email_data.subject}}
      **Received:** {{email_data.timestamp}}
      
      ## Phishing Indicators Found
      
      {{indicators.summary}}
      
      ### Sender Analysis
      {{indicators.sender_spoofing}}
      
      ### Content Analysis
      {{indicators.urgency_tactics}}
      
      ### Link Analysis
      {{indicators.suspicious_links}}
      
      ### Attachment Analysis
      {{indicators.attachments}}
      
      ## Threat Intelligence
      
      {{threat_intel.summary}}
      
      ## Recommended Actions
      
      {{verdict.recommended_actions}}
      
      ---
      
      {% if verdict.classification == 'CONFIRMED_PHISHING' or verdict.classification == 'LIKELY_PHISHING' %}
      ## Incident Response
      
      **Create Incident:** Yes
      **Priority:** {{verdict.risk_level}}
      **Actions:**
      - Quarantine email from all mailboxes
      - Block sender domain
      - Alert affected users
      - Add IOCs to blocklist
      - Monitor for similar emails
      {% else %}
      **No incident required** - Email appears safe or low risk
      {% endif %}
      
      **Analysis Method:** Automated
      **Template:** {{template.name}} v{{template.version}}
