name: sentinel_playbook
description: Automated playbook execution for Microsoft Sentinel alerts
version: 1.0.0
author: Security Templates
tags: [security, sentinel, playbook, automation, soar]

config:
  defaults:
    provider: anthropic
    model: claude-3-5-sonnet
    temperature: 0.2
    max_tokens: 5000

steps:
  # Step 1: Parse Sentinel alert
  - name: parse_alert
    prompt: |
      Parse Microsoft Sentinel alert:
      
      {{input_data.sentinel_alert}}
      
      Extract:
      - Alert ID
      - Alert name
      - Severity
      - Tactics (MITRE ATT&CK)
      - Entities involved (users, hosts, IPs, files)
      - Query results
      - Time generated
      - Description
      
      Structure the alert data for investigation.
    output: alert_data

  # Step 2: Execute investigation steps based on alert type
  - name: investigate
    prompt: |
      Execute investigation playbook for this alert:
      
      **Alert:** {{alert_data.alert_name}}
      **Severity:** {{alert_data.severity}}
      **Tactics:** {{alert_data.tactics}}
      
      **Entities:**
      {{alert_data.entities}}
      
      Based on alert type, execute appropriate investigation:
      
      ### If Suspicious Sign-in:
      1. Check user's recent sign-in history
      2. Verify location against user's normal patterns
      3. Check for concurrent sign-ins from different locations
      4. Review MFA status
      5. Assess risk score
      
      ### If Malware Detection:
      1. Identify affected host(s)
      2. Check if malware is known (hash lookup)
      3. Determine blast radius (lateral movement)
      4. Review recent process execution
      5. Check for persistence mechanisms
      
      ### If Data Exfiltration:
      1. Identify source and destination
      2. Calculate data volume transferred
      3. Check if destination is known/expected
      4. Review user's data access patterns
      5. Assess sensitivity of data
      
      ### If Privilege Escalation:
      1. Identify escalated account
      2. Review what privileges gained
      3. Check recent commands executed
      4. Assess if escalation was authorized
      5. Look for related suspicious activity
      
      Execute appropriate investigation steps and document findings.
      
      Note: In production, this would query Sentinel/Azure logs directly.
      Provide structured investigation findings.
    output: investigation

  # Step 3: Determine response actions
  - name: determine_response
    prompt: |
      Determine appropriate response actions:
      
      **Alert:** {{alert_data}}
      **Investigation:** {{investigation}}
      
      Based on findings, recommend response actions:
      
      **Immediate Containment:**
      - Disable user account?
      - Isolate affected system?
      - Block IP address?
      - Revoke access tokens?
      - Kill malicious processes?
      
      **Investigation Actions:**
      - Collect forensic evidence
      - Analyze memory dump
      - Review logs (30/90 days)
      - Interview user
      - Check related systems
      
      **Remediation:**
      - Remove malware
      - Reset credentials
      - Patch vulnerabilities
      - Update security rules
      - Improve detection
      
      **Communication:**
      - Notify user
      - Alert security team
      - Inform management
      - Legal/compliance notification
      - External reporting (if required)
      
      Prioritize actions: IMMEDIATE / URGENT / ROUTINE
      
      Return structured response plan.
    output: response_plan

  # Step 4: Execute automated responses (if safe)
  - name: auto_response
    condition: "{{response_plan.auto_executable}} == true"
    prompt: |
      Execute automated response actions:
      
      **Response Plan:**
      {{response_plan}}
      
      **Safe to auto-execute:**
      {{response_plan.immediate_actions}}
      
      Note: In production, this would execute via:
      - Azure AD (disable accounts)
      - Defender for Endpoint (isolate hosts)
      - Azure Firewall (block IPs)
      - Conditional Access (revoke tokens)
      
      Document which actions were executed automatically.
    output: auto_actions

  # Step 5: Create incident ticket
  - name: create_incident
    prompt: |
      Create incident ticket:
      
      # Security Incident
      
      **Alert ID:** {{alert_data.alert_id}}
      **Severity:** {{alert_data.severity}}
      **Created:** {{execution.timestamp}}
      
      ## Alert Details
      
      **Alert Name:** {{alert_data.alert_name}}
      **Tactics:** {{alert_data.tactics}}
      **Entities:** {{alert_data.entities}}
      
      ## Investigation Summary
      
      {{investigation.summary}}
      
      ## Key Findings
      
      {{investigation.findings}}
      
      ## Response Actions Taken
      
      ### Automated Actions
      {{auto_actions}}
      
      ### Manual Actions Required
      {{response_plan.manual_actions}}
      
      ## Next Steps
      
      1. {{response_plan.next_steps}}
      
      ## Assignment
      
      **Priority:** {{response_plan.priority}}
      **SLA:** {{response_plan.sla}}
      **Assigned To:** {{response_plan.assignment}}
      
      ---
      
      **Playbook:** {{template.name}} v{{template.version}}
      **Execution Time:** {{execution.duration}}
    output: incident_ticket

  # Step 6: Generate playbook report
  - name: playbook_report
    prompt: |
      # Sentinel Playbook Execution Report
      
      **Alert:** {{alert_data.alert_id}} - {{alert_data.alert_name}}
      **Executed:** {{execution.timestamp}}
      **Template:** {{template.name}} v{{template.version}}
      
      ---
      
      ## Alert Summary
      
      **Severity:** {{alert_data.severity}}
      **Tactics:** {{alert_data.tactics}}
      **Entities Involved:** {{alert_data.entities.count}}
      
      {{alert_data.description}}
      
      ---
      
      ## Investigation Executed
      
      {{investigation.summary}}
      
      **Investigation Steps:**
      {{investigation.steps_completed}}
      
      **Findings:**
      {{investigation.findings}}
      
      **Confidence:** {{investigation.confidence}}
      
      ---
      
      ## Response Actions
      
      ### Automated Actions Taken
      
      {{auto_actions.summary}}
      
      Time to execute: {{auto_actions.duration}}
      
      ### Manual Actions Required
      
      {{response_plan.manual_actions}}
      
      Priority: {{response_plan.priority}}
      SLA: {{response_plan.sla}}
      
      ---
      
      ## Incident Created
      
      **Ticket:** {{incident_ticket.id}}
      **Assigned To:** {{incident_ticket.assigned_to}}
      **Status:** {{incident_ticket.status}}
      
      **Link:** {{incident_ticket.url}}
      
      ---
      
      ## Metrics
      
      - Alert received: {{input_data.alert_timestamp}}
      - Playbook started: {{execution.start_time}}
      - Investigation completed: {{investigation.completed_time}}
      - Response initiated: {{auto_actions.start_time}}
      - Incident created: {{incident_ticket.created_time}}
      - **Total time to triage:** {{execution.total_duration}}
      
      ---
      
      ## Next Steps
      
      1. Security analyst reviews incident: {{incident_ticket.id}}
      2. Validate automated actions taken
      3. Execute manual response actions
      4. Monitor for related activity
      5. Update playbook if needed
      
      **Automated by:** Sentinel Playbook Template
      **Human review required:** {% if response_plan.requires_review %}Yes{% else %}No{% endif %}
