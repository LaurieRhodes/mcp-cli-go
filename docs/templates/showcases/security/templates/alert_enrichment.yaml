name: alert_enrichment
description: SOAR-style automated alert enrichment and intelligent triage
version: 1.0.0
author: Security Templates
tags: [security, soar, alert-triage, threat-intel, automation]

config:
  defaults:
    provider: anthropic
    model: claude-3-5-sonnet
    temperature: 0.2  # Lower for security analysis
    max_tokens: 6000

steps:
  # Step 1: Extract IOCs from alert
  - name: extract_iocs
    prompt: |
      Extract indicators of compromise from this security alert:
      
      ```
      {{input_data.alert}}
      ```
      
      Extract and structure as JSON:
      
      ```json
      {
        "ip_addresses": {
          "source": [],
          "destination": [],
          "external": []
        },
        "domains": [],
        "urls": [],
        "file_hashes": {
          "md5": [],
          "sha1": [],
          "sha256": []
        },
        "email_addresses": [],
        "user_accounts": [],
        "process_names": [],
        "registry_keys": [],
        "command_lines": []
      }
      ```
      
      Be comprehensive - extract all potential IOCs from alert data.
    output: iocs

  # Step 2: Enrich IOCs with threat intelligence
  - name: threat_intel_check
    provider: anthropic
    prompt: |
      Analyze these indicators for known threats:
      
      **IOCs Extracted:**
      {{iocs}}
      
      For each IOC category, assess:
      
      **IP Addresses:**
      - Known malicious IPs? (documented malware C2, known bad actors)
      - Reputation (clean, suspicious, malicious)
      - Geolocation concerns
      - ASN ownership
      
      **Domains:**
      - Recently registered? (common in phishing)
      - Typosquatting (similar to legitimate domains)
      - Known malicious domains
      - Suspicious TLD (.tk, .ml, etc.)
      
      **File Hashes:**
      - Known malware families
      - File reputation
      - First seen date
      
      **Processes:**
      - Known malicious tools (Mimikatz, Cobalt Strike, etc.)
      - Living-off-the-land binaries (LOLBins)
      - Suspicious process behavior
      
      **Command Lines:**
      - Obfuscation detected
      - Known attack patterns
      - Encoded commands
      
      Return structured assessment with threat indicators found.
    output: threat_intel

  # Step 3: Analyze user and system context
  - name: contextual_analysis
    provider: anthropic
    prompt: |
      Analyze the context of this alert:
      
      **Alert Details:**
      {{input_data.alert}}
      
      **Extracted IOCs:**
      {{iocs}}
      
      Consider:
      
      **User Context:**
      - User account involved: {{iocs.user_accounts}}
      - Normal behavior for this user?
      - Time of activity (business hours vs off-hours)
      - Location (expected vs unexpected)
      - Account age and privileges
      
      **System Context:**
      - Source/destination systems
      - Expected communication patterns
      - System criticality (DC, file server, workstation)
      - Patch level concerns
      
      **Timing Context:**
      - Alert timestamp: {{input_data.alert.timestamp}}
      - Business hours or after hours?
      - Weekend/holiday activity?
      - Consistent with normal operations?
      
      Return contextual assessment.
    output: context_analysis

  # Step 4: Correlate with historical patterns
  - name: historical_correlation
    provider: anthropic
    prompt: |
      Analyze historical patterns related to this alert:
      
      **Current Alert:**
      {{input_data.alert}}
      
      **IOCs:**
      {{iocs}}
      
      Consider:
      
      **Historical Patterns to Check:**
      - Has this user triggered similar alerts before?
      - Has this source IP appeared in previous incidents?
      - Is this process execution pattern seen before?
      - Similar alerts in last 30/90 days?
      - Escalation patterns (were similar alerts real threats?)
      
      **Pattern Analysis:**
      - Isolated incident or part of campaign?
      - First occurrence or recurring behavior?
      - Matches known attack patterns?
      
      Note: In production, this would query SIEM historical data.
      For now, analyze based on alert details and typical patterns.
      
      Return correlation findings.
    output: historical_patterns

  # Step 5: Comprehensive threat analysis
  - name: threat_assessment
    provider: anthropic
    prompt: |
      Perform comprehensive threat assessment:
      
      **Original Alert:**
      {{input_data.alert}}
      
      **Extracted IOCs:**
      {{iocs}}
      
      **Threat Intelligence:**
      {{threat_intel}}
      
      **Contextual Analysis:**
      {{context_analysis}}
      
      **Historical Patterns:**
      {{historical_patterns}}
      
      **Assessment Required:**
      
      1. **Severity Rating:**
         - CRITICAL: Active attack in progress, immediate response required
         - HIGH: Likely threat, investigate within 1 hour
         - MEDIUM: Suspicious activity, investigate within 4 hours
         - LOW: Minor anomaly, review when available
         - FALSE_POSITIVE: Benign activity, safe to close
      
      2. **Confidence Level:**
         - HIGH: Strong evidence, clear indicators
         - MEDIUM: Probable but needs validation
         - LOW: Uncertain, human review recommended
      
      3. **Threat Type:** (if applicable)
         - Malware infection
         - Phishing/social engineering
         - Credential compromise
         - Lateral movement
         - Data exfiltration
         - Privilege escalation
         - Reconnaissance
         - Denial of service
      
      4. **Key Evidence:**
         List 3-5 specific findings that support your assessment
      
      5. **Recommended Actions:**
         Immediate steps SOC analyst should take
      
      6. **Priority:**
         P1 (Critical - 15min SLA)
         P2 (High - 1hr SLA)
         P3 (Medium - 4hr SLA)
         P4 (Low - 24hr SLA)
      
      Return structured assessment in this format:
      
      ```json
      {
        "severity": "CRITICAL|HIGH|MEDIUM|LOW|FALSE_POSITIVE",
        "confidence": "HIGH|MEDIUM|LOW",
        "threat_type": "...",
        "summary": "Brief explanation",
        "evidence": ["item1", "item2", "item3"],
        "recommended_actions": ["action1", "action2"],
        "priority": "P1|P2|P3|P4",
        "explanation": "Detailed reasoning"
      }
      ```
    output: threat_assessment

  # Step 6: Generate incident summary
  - name: generate_summary
    provider: anthropic
    prompt: |
      Generate comprehensive incident summary:
      
      # Alert Triage Report
      
      **Alert ID:** {{input_data.alert.id}}
      **Timestamp:** {{execution.timestamp}}
      **Processing Time:** [seconds to complete analysis]
      
      ## Disposition
      
      **Severity:** {{threat_assessment.severity}}
      **Confidence:** {{threat_assessment.confidence}}
      **Priority:** {{threat_assessment.priority}}
      
      ## Summary
      
      {{threat_assessment.summary}}
      
      ## Threat Analysis
      
      **Threat Type:** {{threat_assessment.threat_type}}
      
      **Key Evidence:**
      {{threat_assessment.evidence}}
      
      **Reasoning:**
      {{threat_assessment.explanation}}
      
      ## Indicators of Compromise
      
      {{iocs}}
      
      ## Threat Intelligence Findings
      
      {{threat_intel}}
      
      ## Contextual Analysis
      
      {{context_analysis}}
      
      ## Historical Correlation
      
      {{historical_patterns}}
      
      ## Recommended Actions
      
      {{threat_assessment.recommended_actions}}
      
      ---
      
      ## Next Steps
      
      {% if threat_assessment.severity == 'CRITICAL' %}
      **IMMEDIATE ACTION REQUIRED**
      - Escalate to senior analyst
      - Create P1 incident
      - Begin containment procedures
      {% elif threat_assessment.severity == 'HIGH' %}
      **ACTION REQUIRED**
      - Create incident ticket
      - Investigate within 1 hour
      - Monitor for escalation
      {% elif threat_assessment.severity == 'MEDIUM' %}
      **INVESTIGATION NEEDED**
      - Create ticket for investigation
      - Review within 4 hours
      {% elif threat_assessment.severity == 'LOW' %}
      **REVIEW WHEN AVAILABLE**
      - Add to backlog
      - Review within 24 hours
      {% else %}
      **CLOSE AS FALSE POSITIVE**
      - Document reasoning
      - Update alert tuning if needed
      {% endif %}
      
      ---
      
      **Automated Analysis:** Yes  
      **Human Review Required:** {% if threat_assessment.confidence == 'LOW' %}Yes{% else %}Optional{% endif %}  
      **Template Version:** {{template.version}}
