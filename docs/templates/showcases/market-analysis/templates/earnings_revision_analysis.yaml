name: earnings_revision_analysis
description: Track earnings estimate revisions and guidance trends (more predictive than historical results)
version: 1.0.0
author: Market Analysis Templates
tags: [earnings, estimates, revisions, guidance, forward-looking]

config:
  defaults:
    provider: anthropic
    model: claude-3-5-sonnet
    temperature: 0.2
    max_tokens: 6000

# Data sources
servers:
  - estimize-api      # PAID $50/month - crowdsourced estimates (RECOMMENDED)
  - yahoo-finance     # FREE - basic consensus data (limited)
  - factset-api       # PAID $$$ - institutional-grade (optional)

steps:
  # Step 1: Get current earnings estimates
  - name: get_current_estimates
    servers: [estimize-api, yahoo-finance]
    prompt: |
      Get earnings estimates for {{input_data.ticker}}:
      
      **From Estimize API (if available):**
      ```
      GET /api/v1/estimates/{ticker}
      params:
        periods: ['current_q', 'next_q', 'current_fy', 'next_fy']
      ```
      
      **Data needed:**
      
      1. **Current Quarter (Q):**
         - Wall Street consensus EPS
         - Estimize consensus (crowdsourced, often more accurate)
         - Number of estimates
         - High/low range
      
      2. **Next Quarter (Q+1):**
         - Same data as above
      
      3. **Current Fiscal Year (FY):**
         - Full year EPS estimate
         - Revenue estimate
      
      4. **Next Fiscal Year (FY+1):**
         - Same as current FY
      
      **From Yahoo Finance (fallback if no Estimize):**
      - Basic consensus only (less detailed)
      
      Return estimates:
      ```json
      {
        "current_quarter": {
          "period": "Q4 2024",
          "earnings_date": "2025-01-30",
          "days_until": 33,
          "eps_estimate": 2.15,
          "eps_high": 2.25,
          "eps_low": 2.05,
          "num_analysts": 42,
          "revenue_estimate": 125000000000
        },
        "next_quarter": {
          "period": "Q1 2025",
          "eps_estimate": 1.95,
          "num_analysts": 38
        },
        "current_fy": {
          "period": "FY 2024",
          "eps_estimate": 7.85,
          "revenue_estimate": 485000000000
        },
        "next_fy": {
          "period": "FY 2025", 
          "eps_estimate": 8.90,
          "revenue_estimate": 535000000000,
          "growth_vs_fy2024": 0.134
        }
      }
      ```
    output: current_estimates
  
  # Step 2: Track estimate revisions
  - name: track_revisions
    servers: [estimize-api]
    prompt: |
      Track how estimates have changed for {{input_data.ticker}}:
      
      **Timeframes to analyze:**
      - Past {{input_data.lookback_days[0] | default: 30}} days
      - Past {{input_data.lookback_days[1] | default: 60}} days
      - Past {{input_data.lookback_days[2] | default: 90}} days
      
      **For each timeframe, calculate:**
      
      1. **EPS Revisions:**
         - Starting consensus (beginning of period)
         - Current consensus
         - Absolute change (dollars)
         - Percent change
         - Direction (UP/DOWN/FLAT)
      
      2. **Analyst Actions:**
         - Number of upgrades (raised estimates)
         - Number of downgrades (lowered estimates)
         - Net revisions (upgrades - downgrades)
         - Revision ratio (upgrades / total revisions)
      
      3. **Revision Momentum:**
         - Accelerating (more upgrades recently)
         - Decelerating (upgrades slowing)
         - Stable
      
      **Why revisions matter MORE than historical earnings:**
      
      Example:
      Company beats by 5% but lowers next Q guidance → Stock down
      Company misses by 2% but raises next Q guidance → Stock up
      
      Forward-looking > Backward-looking
      
      Return revision analysis:
      ```json
      {
        "revisions_30d": {
          "eps_change": 0.18,
          "eps_change_pct": 9.1,
          "direction": "UP",
          "upgrades": 12,
          "downgrades": 2,
          "net_revisions": 10,
          "revision_ratio": 0.86,
          "interpretation": "STRONG_POSITIVE"
        },
        "revisions_60d": {
          "eps_change": 0.25,
          "eps_change_pct": 13.2,
          "direction": "UP",
          "upgrades": 18,
          "downgrades": 3,
          "net_revisions": 15,
          "revision_ratio": 0.86
        },
        "revisions_90d": {
          "eps_change": 0.30,
          "eps_change_pct": 16.7,
          "direction": "UP",
          "upgrades": 24,
          "downgrades": 5,
          "net_revisions": 19,
          "revision_ratio": 0.83
        },
        "momentum": {
          "trend": "ACCELERATING",
          "note": "Upgrades continuing, no sign of slowdown"
        }
      }
      ```
    output: revision_data
  
  # Step 3: Analyze earnings surprise history
  - name: analyze_surprise_history
    servers: [yahoo-finance]
    prompt: |
      Analyze past earnings surprises for {{input_data.ticker}}:
      
      **Get last 4 quarters:**
      - Actual EPS reported
      - Estimated EPS (at time)
      - Surprise (actual - estimated)
      - Surprise % ((actual - est) / est)
      - Stock reaction (% change day after)
      
      **Look for patterns:**
      
      1. **Beat Streak:**
         - Company that beat 3+ quarters: 85% likely beats again
         - Builds credibility with analysts
      
      2. **Miss Streak:**
         - Company that missed 2+ quarters: 60% likely misses again
         - Analysts lose confidence, set lower bar
      
      3. **Guidance Pattern:**
         - Does company sandbag (conservative guidance)?
         - Or overpromise and underdeliver?
      
      Return surprise history:
      ```json
      {
        "last_4_quarters": [
          {
            "quarter": "Q3 2024",
            "date": "2024-10-31",
            "actual_eps": 2.18,
            "estimated_eps": 2.02,
            "surprise": 0.16,
            "surprise_pct": 7.9,
            "stock_reaction": 3.5
          },
          {
            "quarter": "Q2 2024",
            "actual_eps": 1.95,
            "estimated_eps": 1.88,
            "surprise": 0.07,
            "surprise_pct": 3.7,
            "stock_reaction": 1.2
          },
          {
            "quarter": "Q1 2024",
            "actual_eps": 1.82,
            "estimated_eps": 1.75,
            "surprise": 0.07,
            "surprise_pct": 4.0,
            "stock_reaction": 2.1
          },
          {
            "quarter": "Q4 2023",
            "actual_eps": 2.10,
            "estimated_eps": 1.98,
            "surprise": 0.12,
            "surprise_pct": 6.1,
            "stock_reaction": 4.2
          }
        ],
        "beat_streak": 4,
        "avg_surprise_pct": 5.4,
        "pattern": "CONSISTENT_BEATER",
        "guidance_style": "CONSERVATIVE (sandbagging)"
      }
      ```
    output: surprise_history
  
  # Step 4: Assess earnings momentum
  - name: assess_earnings_momentum
    prompt: |
      Assess overall earnings momentum for {{input_data.ticker}}:
      
      **Current Estimates:**
      {{current_estimates}}
      
      **Revision Trends:**
      {{revision_data}}
      
      **Surprise History:**
      {{surprise_history}}
      
      ## Analysis Framework
      
      ### Factor 1: Revision Trend (Most Important)
      
      **30-day revisions:**
      - Change: {{revision_data.revisions_30d.eps_change_pct}}%
      - Direction: {{revision_data.revisions_30d.direction}}
      - Net revisions: {{revision_data.revisions_30d.net_revisions}}
      
      Interpretation:
      - Upgrades > 10: Very positive
      - Upgrades 5-10: Positive
      - Net zero: Neutral
      - Downgrades > 5: Negative
      
      **Revision momentum:**
      {{revision_data.momentum.trend}}
      
      ### Factor 2: Beat History
      
      **Beat streak:** {{surprise_history.beat_streak}} quarters
      **Average surprise:** {{surprise_history.avg_surprise_pct}}%
      **Pattern:** {{surprise_history.pattern}}
      
      Probability of beat:
      - 4+ beat streak: 85% likely beats again
      - 2-3 beat streak: 70% likely
      - No pattern: 50/50
      - Miss streak: 40% likely misses
      
      ### Factor 3: Guidance Expectations
      
      Based on pattern:
      - Conservative guiders: Likely to beat and raise
      - Aggressive guiders: Higher risk of miss
      
      Style: {{surprise_history.guidance_style}}
      
      ### Factor 4: Upcoming Catalyst
      
      **Days until earnings:** {{current_estimates.current_quarter.days_until}}
      
      Time horizon:
      - < 14 days: High relevance (imminent)
      - 14-30 days: Medium relevance
      - > 30 days: Lower relevance (too far out)
      
      ## Generate Earnings Signal
      
      **Score components:**
      
      1. Revision trend (0-40 points):
         - Strong upgrades (>15%): 40 points
         - Moderate upgrades (5-15%): 25 points
         - Flat (±5%): 15 points
         - Downgrades: 0 points
         
         30d change: {{revision_data.revisions_30d.eps_change_pct}}%
         Points: {{calculate points}}
      
      2. Beat history (0-30 points):
         - 4+ streak: 30 points
         - 2-3 streak: 20 points
         - 0-1 streak: 10 points
         
         Streak: {{surprise_history.beat_streak}}
         Points: {{calculate points}}
      
      3. Revision momentum (0-20 points):
         - Accelerating: 20 points
         - Stable positive: 15 points
         - Decelerating: 10 points
         
         Momentum: {{revision_data.momentum.trend}}
         Points: {{calculate points}}
      
      4. Time proximity (0-10 points):
         - < 14 days: 10 points
         - 14-30 days: 7 points
         - > 30 days: 3 points
         
         Days: {{current_estimates.current_quarter.days_until}}
         Points: {{calculate points}}
      
      **Total Score:** (0-100)
      - > 75: STRONG_POSITIVE
      - 60-75: POSITIVE
      - 40-60: NEUTRAL
      - 25-40: NEGATIVE
      - < 25: STRONG_NEGATIVE
      
      Generate earnings signal:
      ```json
      {
        "signal": "POSITIVE",
        "score": 72,
        "confidence": 75,
        "trend": "Strong upward estimate revisions continuing",
        
        "key_factors": {
          "revisions_30d": {
            "score": 35,
            "assessment": "VERY_POSITIVE",
            "detail": "12 upgrades vs 2 downgrades, +9.1% EPS increase"
          },
          "beat_history": {
            "score": 30,
            "assessment": "STRONG",
            "detail": "4-quarter beat streak, avg surprise 5.4%"
          },
          "momentum": {
            "score": 18,
            "assessment": "ACCELERATING",
            "detail": "Upgrades continue with no slowdown"
          },
          "catalyst_timing": {
            "score": 7,
            "assessment": "MEDIUM_TERM",
            "detail": "Earnings in 33 days"
          }
        },
        
        "surprise_probability": {
          "beat_likelihood": 85,
          "reasoning": "4-quarter beat streak + positive revisions + conservative guidance style = high probability of beat"
        },
        
        "guidance_expectation": {
          "likely_action": "RAISE",
          "confidence": 70,
          "reasoning": "Positive revision trend suggests business improving, company historically conservative with guidance"
        },
        
        "interpretation": "Strong positive earnings momentum. Analysts have raised estimates 9% in past month with 12 upgrades vs only 2 downgrades. Company has beat 4 quarters in row averaging 5.4% surprise. Positive revisions suggest beat and raise likely. Earnings in 33 days provides medium-term catalyst.",
        
        "risks": [
          "Macro headwinds could impact results despite estimates",
          "High expectations (4 beat streak) = higher bar to impress",
          "33 days out = still time for estimates to change"
        ]
      }
      ```
    output: earnings_signal
  
  # Step 5: Generate summary
  - name: generate_summary
    prompt: |
      # Earnings Momentum Analysis: {{input_data.ticker}}
      
      **Analysis Date:** {{execution.timestamp}}
      **Next Earnings:** {{current_estimates.current_quarter.earnings_date}} ({{current_estimates.current_quarter.days_until}} days)
      
      ---
      
      ## Signal: {{earnings_signal.signal}}
      
      **Score:** {{earnings_signal.score}} / 100
      **Confidence:** {{earnings_signal.confidence}}%
      
      ### Summary
      
      {{earnings_signal.interpretation}}
      
      ---
      
      ## Current Estimates
      
      **Current Quarter ({{current_estimates.current_quarter.period}}):**
      - EPS Estimate: ${{current_estimates.current_quarter.eps_estimate}}
      - Range: ${{current_estimates.current_quarter.eps_low}} - ${{current_estimates.current_quarter.eps_high}}
      - Analysts: {{current_estimates.current_quarter.num_analysts}}
      
      **Next Quarter:**
      - EPS Estimate: ${{current_estimates.next_quarter.eps_estimate}}
      
      **Full Year:**
      - FY {{current_estimates.current_fy.period}}: ${{current_estimates.current_fy.eps_estimate}}
      - FY {{current_estimates.next_fy.period}}: ${{current_estimates.next_fy.eps_estimate}} (+{{current_estimates.next_fy.growth_vs_fy2024 * 100}}%)
      
      ---
      
      ## Revision Trends
      
      ### Past 30 Days
      - EPS change: +${{revision_data.revisions_30d.eps_change}} (+{{revision_data.revisions_30d.eps_change_pct}}%)
      - Upgrades: {{revision_data.revisions_30d.upgrades}}
      - Downgrades: {{revision_data.revisions_30d.downgrades}}
      - **Net: +{{revision_data.revisions_30d.net_revisions}}** ({{revision_data.revisions_30d.interpretation}})
      
      ### Past 60 Days
      - EPS change: +${{revision_data.revisions_60d.eps_change}} (+{{revision_data.revisions_60d.eps_change_pct}}%)
      - Net revisions: +{{revision_data.revisions_60d.net_revisions}}
      
      ### Past 90 Days
      - EPS change: +${{revision_data.revisions_90d.eps_change}} (+{{revision_data.revisions_90d.eps_change_pct}}%)
      - Net revisions: +{{revision_data.revisions_90d.net_revisions}}
      
      **Momentum:** {{revision_data.momentum.trend}}
      - {{revision_data.momentum.note}}
      
      ---
      
      ## Beat History
      
      **Pattern:** {{surprise_history.pattern}}
      **Beat Streak:** {{surprise_history.beat_streak}} quarters
      **Avg Surprise:** {{surprise_history.avg_surprise_pct}}%
      
      {{#each surprise_history.last_4_quarters}}
      - {{this.quarter}}: Beat by {{this.surprise_pct}}% (stock +{{this.stock_reaction}}%)
      {{/each}}
      
      ---
      
      ## Expectations
      
      **Beat Probability:** {{earnings_signal.surprise_probability.beat_likelihood}}%
      - {{earnings_signal.surprise_probability.reasoning}}
      
      **Guidance:** Likely to {{earnings_signal.guidance_expectation.likely_action}}
      - {{earnings_signal.guidance_expectation.reasoning}}
      
      ---
      
      ## Risk Factors
      
      {{#each earnings_signal.risks}}
      ⚠ {{this}}
      {{/each}}
      
      ---
      
      **Data Sources:** {{#if current_estimates.source == 'estimize'}}Estimize{{else}}Yahoo Finance{{/if}}
      **Template:** {{template.name}} v{{template.version}}
