name: nasdaq100_trade_signal
description: Multi-factor analysis for Nasdaq-100 stocks with expert-informed weighting
version: 1.0.0
author: Market Analysis Templates
tags: [trading, nasdaq, multi-factor, options-flow, macro, earnings]

config:
  defaults:
    provider: anthropic
    model: claude-3-5-sonnet
    temperature: 0.2
    max_tokens: 8000

# Required MCP servers and APIs
servers:
  # Macro data (FREE)
  - fred-api           # Federal Reserve Economic Data
  - treasury-api       # US Treasury yield data
  - vix-api            # CBOE Volatility Index
  
  # Options flow (PAID - $50/month)
  - unusual-whales     # Unusual options activity
  - cboe-api           # Options data
  
  # Earnings data (PAID - $50/month OR FREE limited)
  - estimize-api       # Crowdsourced earnings estimates
  - yahoo-finance      # Backup free source
  
  # Market data (FREE)
  - yahoo-finance      # Price, volume, fundamentals
  - alpha-vantage      # Technical indicators
  
  # SEC filings (FREE)
  - sec-edgar          # Form 4, 13F filings

steps:
  # Stage 1: Macro environment analysis (35% weight - CRITICAL)
  - name: analyze_macro_regime
    template: macro_regime_analysis
    template_input:
      date: "{{execution.date}}"
    output: macro_signal
    # Returns: RISK_ON/NEUTRAL/RISK_OFF + confidence + rationale
  
  # Only proceed with detailed analysis if macro not severely negative
  - name: check_macro_environment
    condition: "{{macro_signal.signal}} != 'SEVERE_RISK_OFF'"
    prompt: |
      Macro environment check:
      {{macro_signal}}
      
      If SEVERE_RISK_OFF:
        Recommendation: HOLD CASH (don't fight the Fed)
        Confidence: 95%
      
      Otherwise: Proceed with stock analysis
    output: proceed_decision
  
  # Stage 2: Options flow analysis (25% weight)
  - name: analyze_options_flow
    condition: "{{proceed_decision.continue}} == true"
    template: options_flow_analysis
    template_input:
      ticker: "{{input_data.ticker}}"
      lookback_days: 5
      min_premium: 100000
    output: options_signal
    # Returns: BULLISH/NEUTRAL/BEARISH + conviction + evidence
  
  # Stage 3: Earnings momentum analysis (20% weight)
  - name: analyze_earnings_momentum
    condition: "{{proceed_decision.continue}} == true"
    template: earnings_revision_analysis
    template_input:
      ticker: "{{input_data.ticker}}"
      lookback_days: [30, 60, 90]
    output: earnings_signal
    # Returns: POSITIVE/NEUTRAL/NEGATIVE + trend + surprise_probability
  
  # Stage 4: Relative strength analysis (10% weight)
  - name: analyze_relative_strength
    condition: "{{proceed_decision.continue}} == true"
    template: relative_strength_analysis
    template_input:
      ticker: "{{input_data.ticker}}"
      benchmark: "QQQ"
      sector_etf: "XLK"
      period_days: 20
    output: relative_signal
    # Returns: OUTPERFORMING/NEUTRAL/UNDERPERFORMING + magnitude
  
  # Stage 5: Technical confirmation (5% weight)
  - name: analyze_technical_levels
    condition: "{{proceed_decision.continue}} == true"
    template: technical_confirmation
    template_input:
      ticker: "{{input_data.ticker}}"
      timeframe: "daily"
    output: technical_signal
    # Returns: CONFIRMED/NEUTRAL/NOT_CONFIRMED + key_levels
  
  # Stage 6: Insider activity (5% weight)
  - name: check_insider_activity
    condition: "{{proceed_decision.continue}} == true"
    template: insider_activity_analysis
    template_input:
      ticker: "{{input_data.ticker}}"
      lookback_days: 90
    output: insider_signal
    # Returns: BULLISH/NEUTRAL/BEARISH + cluster_buying
  
  # Stage 7: Get current price and volatility for position sizing
  - name: get_market_data
    condition: "{{proceed_decision.continue}} == true"
    servers: [yahoo-finance, alpha-vantage]
    prompt: |
      Get current market data for {{input_data.ticker}}:
      
      Via Yahoo Finance:
      - Current price
      - Today's volume
      - Average volume (20 days)
      
      Via Alpha Vantage:
      - ATR (14-day) for volatility
      - 50-day moving average
      - 200-day moving average
      
      Return:
      ```json
      {
        "current_price": 195.50,
        "volume": 52000000,
        "avg_volume_20d": 48000000,
        "atr_14d": 3.50,
        "ma_50d": 187.00,
        "ma_200d": 178.00
      }
      ```
    output: market_data
  
  # Stage 8: Calculate volatility-adjusted position size
  - name: calculate_position_size
    condition: "{{proceed_decision.continue}} == true"
    prompt: |
      Calculate position size with volatility adjustment:
      
      **Portfolio Parameters:**
      - Portfolio value: {{input_data.portfolio_value}}
      - Risk per trade: {{input_data.risk_per_trade | default: 0.01}} (1%)
      - Max position size: {{input_data.max_position | default: 0.10}} (10%)
      
      **Stock Data:**
      - Ticker: {{input_data.ticker}}
      - Current price: {{market_data.current_price}}
      - ATR (14-day): {{market_data.atr_14d}}
      - ATR%: {{market_data.atr_14d / market_data.current_price * 100}}%
      
      ## Position Sizing Method
      
      **Step 1: Calculate stop distance**
      Use ATR-based stop (better than fixed -12%):
      - Stop distance: 3 × ATR = {{market_data.atr_14d * 3}}
      - Stop price: Current - Stop distance = {{market_data.current_price - (market_data.atr_14d * 3)}}
      
      **Step 2: Calculate base position**
      - Risk amount: Portfolio × Risk% = {{input_data.portfolio_value * (input_data.risk_per_trade | default: 0.01)}}
      - Shares: Risk / Stop distance = {{(input_data.portfolio_value * 0.01) / (market_data.atr_14d * 3)}}
      - Dollar amount: Shares × Price
      
      **Step 3: Volatility adjustment**
      ATR% = {{market_data.atr_14d / market_data.current_price}}
      
      If ATR% > 3% (high volatility):
        Reduce position by 50%
      
      If ATR% > 5% (very high volatility):
        Reduce position by 75%
      
      If ATR% < 1% (low volatility):
        Can increase by 25% (up to max position size)
      
      **Step 4: Apply position limits**
      Final position must be:
      - Minimum: 1% of portfolio
      - Maximum: {{input_data.max_position | default: 10}}% of portfolio
      
      **Step 5: Calculate take profit (+3% target)**
      - Take profit price: Current × 1.03 = {{market_data.current_price * 1.03}}
      - Target gain: ${{market_data.current_price * 0.03}} per share
      
      Return position sizing:
      ```json
      {
        "shares": 42,
        "dollar_amount": 8211,
        "percent_portfolio": 8.21,
        "entry_price": 195.50,
        "stop_loss": 185.00,
        "stop_loss_pct": -5.37,
        "take_profit": 201.37,
        "take_profit_pct": 3.00,
        "risk_amount": 441,
        "risk_percent": 0.44,
        "risk_reward_ratio": "1:0.63",
        "volatility_adjustment": "None (ATR 1.8%)"
      }
      ```
    output: position_sizing
  
  # Stage 9: Aggregate all signals with expert weighting
  - name: aggregate_signals
    condition: "{{proceed_decision.continue}} == true"
    prompt: |
      Aggregate all signals with expert-informed weighting:
      
      **Signal Inputs:**
      
      1. Macro (35% weight): {{macro_signal}}
         - Most important: Fed policy drives discount rate
         - RISK_ON = favorable for tech
         - RISK_OFF = reduce exposure
      
      2. Options Flow (25% weight): {{options_signal}}
         - Smart money shows up here first
         - Large unusual activity = high conviction
      
      3. Earnings Momentum (20% weight): {{earnings_signal}}
         - Estimate revisions > historical results
         - Upward revisions = positive surprise likely
      
      4. Relative Strength (10% weight): {{relative_signal}}
         - Context matters (vs QQQ/sector)
         - Outperformance = strength
      
      5. Technical (5% weight): {{technical_signal}}
         - Timing/confirmation only
         - Volume confirms direction
      
      6. Insider Activity (5% weight): {{insider_signal}}
         - Delayed data, limited weight
         - Cluster buying = conviction
      
      **Scoring Method:**
      
      Convert each signal to numeric score:
      - STRONG BULLISH/POSITIVE/RISK_ON = +10
      - BULLISH/POSITIVE/OUTPERFORMING = +5
      - NEUTRAL = 0
      - BEARISH/NEGATIVE/UNDERPERFORMING = -5
      - STRONG BEARISH/NEGATIVE/RISK_OFF = -10
      
      Weighted Score = (Macro × 0.35) + (Options × 0.25) + (Earnings × 0.20) + 
                       (Relative × 0.10) + (Technical × 0.05) + (Insider × 0.05)
      
      **Recommendation Thresholds:**
      - Score > 6: STRONG BUY
      - Score 3-6: BUY
      - Score -3 to 3: HOLD
      - Score -6 to -3: SELL
      - Score < -6: STRONG SELL
      
      **Confidence Calculation:**
      - All 6 signals agree direction: 90%+ confidence
      - 5 of 6 agree: 80-90% confidence
      - 4 of 6 agree: 70-80% confidence
      - 3 of 6 agree: 50-70% confidence
      - Signals very mixed: <50% confidence (don't trade)
      
      Calculate and return aggregated signal.
    output: aggregated_score
  
  # Stage 10: Generate final trade recommendation
  - name: generate_recommendation
    prompt: |
      Generate final trade recommendation:
      
      **Stock:** {{input_data.ticker}}
      **Current Price:** ${{market_data.current_price}}
      **Analysis Date:** {{execution.timestamp}}
      
      ---
      
      ## Recommendation: {{aggregated_score.recommendation}}
      
      **Confidence:** {{aggregated_score.confidence}}%
      **Weighted Score:** {{aggregated_score.score}} / 10
      
      ---
      
      ## Trade Details
      
      {% if aggregated_score.recommendation in ['BUY', 'STRONG_BUY'] %}
      
      **Entry:**
      - Price: ${{position_sizing.entry_price}}
      - Timing: At market or limit order
      
      **Position:**
      - Shares: {{position_sizing.shares}}
      - Dollar amount: ${{position_sizing.dollar_amount}}
      - Portfolio allocation: {{position_sizing.percent_portfolio}}%
      
      **Exit Targets:**
      - Take profit: ${{position_sizing.take_profit}} (+{{position_sizing.take_profit_pct}}%)
      - Stop loss: ${{position_sizing.stop_loss}} ({{position_sizing.stop_loss_pct}}%)
      
      **Risk:**
      - Amount at risk: ${{position_sizing.risk_amount}}
      - Risk as % portfolio: {{position_sizing.risk_percent}}%
      - Risk/reward ratio: {{position_sizing.risk_reward_ratio}}
      
      {% else %}
      
      **No position recommended**
      
      {% endif %}
      
      ---
      
      ## Signal Breakdown
      
      ### 1. Macro Environment (35% weight)
      **Signal:** {{macro_signal.signal}}
      **Confidence:** {{macro_signal.confidence}}%
      
      {{macro_signal.rationale}}
      
      ### 2. Options Flow (25% weight)
      **Signal:** {{options_signal.signal}}
      **Confidence:** {{options_signal.confidence}}%
      
      Evidence:
      {{#each options_signal.evidence}}
      - {{this}}
      {{/each}}
      
      ### 3. Earnings Momentum (20% weight)
      **Signal:** {{earnings_signal.signal}}
      **Confidence:** {{earnings_signal.confidence}}%
      
      {{earnings_signal.trend}}
      
      ### 4. Relative Strength (10% weight)
      **Signal:** {{relative_signal.signal}}
      
      {{relative_signal.vs_benchmark}}
      
      ### 5. Technical Levels (5% weight)
      **Signal:** {{technical_signal.signal}}
      
      {{technical_signal.summary}}
      
      ### 6. Insider Activity (5% weight)
      **Signal:** {{insider_signal.signal}}
      
      {{insider_signal.activity}}
      
      ---
      
      ## Rationale
      
      **Why {{aggregated_score.recommendation}}:**
      
      {{#each aggregated_score.pros}}
      ✓ {{this}}
      {{/each}}
      
      **Risk Factors:**
      
      {{#each aggregated_score.cons}}
      ⚠ {{this}}
      {{/each}}
      
      ---
      
      ## Trade Management
      
      {% if aggregated_score.recommendation in ['BUY', 'STRONG_BUY'] %}
      
      **Entry Strategy:**
      - Limit order: ${{position_sizing.entry_price - 1}} - ${{position_sizing.entry_price + 1}}
      - Or market if under ${{position_sizing.entry_price + 2}}
      
      **Exit Strategy:**
      - Take profit at ${{position_sizing.take_profit}} (set limit order)
      - Stop loss at ${{position_sizing.stop_loss}} (set stop order)
      - Consider trailing stop if strong momentum
      
      **Re-evaluate If:**
      - Macro regime shifts to RISK_OFF
      - Unusual selling appears in options flow
      - Earnings estimates reversed
      - Price breaks below {{market_data.ma_50d}} (50-day MA)
      
      **Recommended Hold Period:** 2-4 weeks
      
      {% endif %}
      
      ---
      
      ## Upcoming Events
      
      Check for:
      - Earnings announcement date
      - FOMC meeting dates
      - Ex-dividend date
      - Major economic releases
      
      ---
      
      **Analysis completed in:** {{execution.duration}} seconds
      **Template:** {{template.name}} v{{template.version}}
      **Data sources:** FRED, {{#if servers.unusual-whales}}Unusual Whales{{else}}Yahoo Finance{{/if}}, {{#if servers.estimize}}Estimize{{else}}Yahoo Finance{{/if}}, SEC EDGAR
      
      ---
      
      **Disclaimer:** This is automated analysis, not investment advice. Past performance doesn't guarantee future results. Always use proper risk management and position sizing.
    output: final_recommendation
