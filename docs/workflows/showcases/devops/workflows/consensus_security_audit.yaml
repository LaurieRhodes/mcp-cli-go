$schema: "workflow/v2.0"
name: consensus_security_audit
version: 2.0.0
description: Multi-provider security audit with consensus validation for high-confidence findings

execution:
  provider: anthropic
  model: claude-sonnet-4
  temperature: 0.2  # Lower for security analysis (factual, not creative)

steps:
  # Step 1: Multi-provider consensus security scan
  - name: security_scan
    consensus:
      prompt: |
        Perform comprehensive security audit of this configuration:
        
        ```
        {{input}}
        ```
        
        Check for security vulnerabilities in these categories:
        
        **1. Authentication & Authorization:**
        - Weak authentication mechanisms
        - Missing authorization checks
        - Privilege escalation vectors
        - Token/session management issues
        
        **2. Secrets Management:**
        - Hardcoded credentials
        - Exposed API keys
        - Unencrypted sensitive data
        - Secrets in environment variables
        
        **3. Network Security:**
        - Overly permissive network policies
        - Unnecessary port exposure
        - Missing TLS/encryption
        - Insecure protocols (HTTP, FTP)
        
        **4. Access Control:**
        - Excessive permissions
        - Running as root/admin
        - Missing principle of least privilege
        - Service account misuse
        
        **5. Input Validation:**
        - Command injection risks
        - SQL injection vectors
        - Path traversal vulnerabilities
        - Unsafe deserialization
        
        **6. Resource Management:**
        - Missing resource limits
        - DoS vulnerabilities
        - Unbounded operations
        - Memory/CPU exhaustion risks
        
        **7. Known Vulnerabilities:**
        - OWASP Top 10 issues
        - CWE Common Weakness patterns
        - CVEs in dependencies
        - Outdated versions
        
        For EACH finding, provide:
        ```
        Severity: [CRITICAL|HIGH|MEDIUM|LOW]
        Category: [category from above]
        Title: [Brief title]
        Description: [What is the security issue?]
        Location: [Where in the config?]
        Impact: [What could an attacker do?]
        Remediation: [Specific fix with example code]
        References: [OWASP, CWE, CVE references if applicable]
        ```
        
        Return findings as a structured list, ordered by severity.
      executions:
        # Provider 1: Anthropic Claude (strong reasoning, security focus)
        - provider: anthropic
          model: claude-sonnet-4
          temperature: 0.2
        
        # Provider 2: OpenAI GPT-4o (broad knowledge base, pattern recognition)
        - provider: openai
          model: gpt-4o
          temperature: 0.2
        
        # Provider 3: DeepSeek (cost-effective validation)
        - provider: deepseek
          model: deepseek-chat
          temperature: 0.2
      require: 2/3  # At least 2 of 3 must agree
      timeout: 120s

  # Step 2: Analyze consensus results
  - name: analyze_consensus
    needs: [security_scan]
    provider: anthropic
    model: claude-sonnet-4
    run: |
      Analyze the consensus security audit results:
      
      {{security_scan}}
      
      Provide:
      
      ## HIGH CONFIDENCE FINDINGS
      
      Findings where providers agree or strongly agree:
      - Finding title and severity
      - Provider agreement level
      - Why this is high confidence
      - Immediate action required
      
      ## PRIORITY ASSESSMENT
      
      **IMMEDIATE ACTIONS (CRITICAL/HIGH severity with consensus):**
      [List findings requiring immediate fix]
      
      **SHORT-TERM ACTIONS (MEDIUM severity with consensus):**
      [List validated medium-priority findings]
      
      **REVIEW REQUIRED (Any severity conflicts):**
      [List items where providers disagree on severity]
      
      ## SUMMARY STATISTICS
      
      - Total findings: [count]
      - Consensus level: [percentage]%
      - Critical: [count]
      - High: [count]
      - Medium: [count]
      - Low: [count]

  # Step 3: Generate comprehensive audit report
  - name: audit_report
    needs: [analyze_consensus]
    run: |
      Create comprehensive security audit report in markdown format:
      
      # Security Audit Report - Multi-Provider Consensus
      
      **Date:** {{execution.timestamp}}
      **Workflow:** {{workflow.name}} v{{workflow.version}}
      **Consensus Requirement:** 2 of 3 providers must agree
      
      ---
      
      ## Executive Summary
      
      This security audit used consensus validation across three AI providers 
      (Anthropic Claude, OpenAI GPT-4o, DeepSeek). This multi-provider approach:
      
      - **Increases confidence:** Findings most providers agree on are highly reliable
      - **Reduces false positives:** Requires validation across independent systems
      - **Identifies consensus:** Quantifies agreement level on each finding
      
      [Provide 2-3 sentence summary of overall security posture]
      
      ---
      
      ## Consensus Analysis
      
      {{analyze_consensus}}
      
      ---
      
      ## Prioritized Action Plan
      
      ### IMMEDIATE ACTIONS (Before Production)
      
      Address all consensus-validated CRITICAL or HIGH severity findings.
      
      **Risk if not addressed:** [Explain critical risks]
      
      ### SHORT-TERM ACTIONS (This Sprint)
      
      Address consensus-validated MEDIUM severity findings.
      
      ### MANUAL REVIEW REQUIRED
      
      Review items where providers disagreed on severity or presence.
      These may represent edge cases requiring expert judgment.
      
      ---
      
      ## Detailed Findings
      
      {{security_scan}}
      
      ---
      
      ## Confidence Assessment
      
      **Methodology:** Multi-provider consensus validation
      
      - Consensus findings have higher confidence
      - Disagreements flagged for manual review
      - Agreement level quantified for each finding
      
      ---
      
      ## Next Steps
      
      1. **Immediate:** Address consensus CRITICAL/HIGH findings
      2. **This week:** Review any severity conflicts
      3. **This sprint:** Address consensus MEDIUM findings
      4. **Re-audit:** Run workflow again after fixes to verify resolution
      
      ---
      
      ## Appendix: Configuration Audited
      
      <details>
      <summary>Full configuration</summary>
      
      ```
      {{input}}
      ```
      
      </details>
      
      ---
      
      **Note:** This report uses consensus validation to increase confidence.
      All findings should be reviewed by qualified security professionals.

# Usage:
#
# ./mcp-cli --workflow consensus_security_audit --input-data "$(cat config.yaml)"
#
# Or with specific config type:
# ./mcp-cli --workflow consensus_security_audit --input-data '{
#   "config": "...",
#   "type": "kubernetes",
#   "environment": "production"
# }'
#
# Business Value:
# - Reduces false positives through consensus validation
# - Increases confidence in findings (2+ providers agree)
# - Quantifies agreement level for risk assessment
# - Systematic prioritization for remediation
