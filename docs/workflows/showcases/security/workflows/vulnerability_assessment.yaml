$schema: "workflow/v2.0"
name: vulnerability_assessment
version: 2.0.0
description: Vulnerability assessment with consensus-based severity and remediation priority

execution:
  provider: anthropic
  model: claude-sonnet-4
  temperature: 0.3
  servers: [brave-search]

steps:
  # Step 1: Parse vulnerability report
  - name: parse_vulnerability
    run: |
      Parse this vulnerability report:
      
      {{input}}
      
      Extract:
      - CVE ID(s)
      - Affected software/version
      - Vulnerability type (SQL injection, XSS, RCE, etc.)
      - CVSS score (if provided)
      - Description
      - Affected systems/count
      - Current mitigations (if any)
      
      Return structured summary.

  # Step 2: Consensus severity assessment
  - name: severity_consensus
    needs: [parse_vulnerability]
    consensus:
      prompt: |
        Assess vulnerability severity with consensus:
        
        {{parse_vulnerability}}
        
        Evaluate:
        
        **1. Exploitability:**
        - PUBLIC: Exploit code publicly available
        - FUNCTIONAL: Working exploit exists
        - PROOF-OF-CONCEPT: PoC available but not weaponized
        - THEORETICAL: No known exploits
        
        **2. Business Impact:**
        - CRITICAL: Data breach, system compromise, compliance violation
        - HIGH: Service disruption, privilege escalation
        - MEDIUM: Information disclosure, DoS
        - LOW: Minor information leak, requires auth
        
        **3. Attack Complexity:**
        - LOW: Easy to exploit, no special conditions
        - MEDIUM: Requires some user interaction
        - HIGH: Requires multiple conditions or insider access
        
        **4. Remediation Urgency:**
        - EMERGENCY (patch within 24 hours)
        - URGENT (patch within 7 days)
        - STANDARD (patch within 30 days)
        - LOW (patch next maintenance window)
        
        **5. Compensating Controls:**
        - What mitigations reduce risk?
        - Are they effective?
        - Can we defer patching safely?
        
        Provide severity rating and urgency recommendation.
      executions:
        - provider: anthropic
          model: claude-sonnet-4
          temperature: 0.2
        - provider: openai
          model: gpt-4o
          temperature: 0.2
        - provider: deepseek
          model: deepseek-chat
          temperature: 0.2
      require: unanimous  # All must agree for critical vulnerabilities
      timeout: 90s

  # Step 3: Exploit intelligence gathering
  - name: exploit_intel
    needs: [parse_vulnerability]
    run: |
      Gather exploit intelligence:
      
      Vulnerability: {{parse_vulnerability}}
      
      Search for:
      1. **Public Exploits:**
         - Exploit-DB
         - Metasploit modules
         - GitHub proof-of-concepts
         - Security researcher blogs
      
      2. **Active Exploitation:**
         - Is this being exploited in the wild?
         - Any ransomware campaigns using this?
         - APT groups known to use this?
      
      3. **Vendor Information:**
         - Official security advisory
         - Patch availability
         - Workarounds or mitigations
         - Known issues with patch
      
      4. **Timeline:**
         - Disclosure date
         - Patch release date
         - First exploit seen
         - Attack volume trend
      
      Summarize exploit landscape and urgency indicators.

  # Step 4: Generate remediation plan
  - name: remediation_plan
    needs: [severity_consensus, exploit_intel]
    run: |
      Create remediation plan:
      
      Vulnerability: {{parse_vulnerability}}
      Severity Assessment: {{severity_consensus}}
      Exploit Intelligence: {{exploit_intel}}
      
      **PRIORITY CLASSIFICATION:**
      [Extract from consensus - EMERGENCY/URGENT/STANDARD/LOW]
      
      **IMMEDIATE MITIGATIONS (If patch not possible now):**
      1. [First workaround/mitigation]
         - Implementation steps
         - Effectiveness rating
         - Limitations
      2. [Second mitigation if applicable]
      
      **PATCHING STRATEGY:**
      
      **Phase 1 - Critical Systems (Within [timeframe]):**
      - Systems: [List critical affected systems]
      - Patch version: [Version number]
      - Testing required: [Yes/No and scope]
      - Rollback plan: [How to rollback if issues]
      - Downtime window: [Duration]
      
      **Phase 2 - Production Systems (Within [timeframe]):**
      - Systems: [List production systems]
      - Maintenance window: [When]
      - Dependencies: [Other systems affected]
      
      **Phase 3 - Non-Critical (Within [timeframe]):**
      - Systems: [List remaining systems]
      - Batch deployment: [Strategy]
      
      **VALIDATION:**
      1. [How to verify patch applied]
      2. [How to verify vulnerability fixed]
      3. [How to verify no regression]
      
      **RISK ACCEPTANCE (If deferring):**
      - Justification for deferral
      - Compensating controls in place
      - Risk acceptance authority
      - Review date

  # Step 5: Generate vulnerability report
  - name: vulnerability_report
    needs: [remediation_plan]
    run: |
      Generate comprehensive vulnerability assessment report:
      
      # Vulnerability Assessment Report
      
      **Assessment ID:** {{workflow.execution_id}}
      **Date:** {{execution.timestamp}}
      **Workflow:** {{workflow.name}} v{{workflow.version}}
      
      ---
      
      ## Vulnerability Summary
      
      {{parse_vulnerability}}
      
      ---
      
      ## Consensus Severity Assessment
      
      {{severity_consensus}}
      
      **Consensus Agreement:** [Extract agreement level]
      **All Providers Agree:** [Yes/No]
      **Recommended Priority:** [EMERGENCY/URGENT/STANDARD/LOW]
      
      ---
      
      ## Exploit Intelligence
      
      {{exploit_intel}}
      
      **Public Exploit Available:** [Yes/No]
      **Active Exploitation:** [Yes/No]
      **Patch Available:** [Yes/No]
      
      ---
      
      ## Remediation Plan
      
      {{remediation_plan}}
      
      ---
      
      ## Decision Matrix
      
      | Factor | Assessment | Impact on Priority |
      |--------|------------|-------------------|
      | Exploitability | [Level] | [High/Medium/Low] |
      | Business Impact | [Level] | [High/Medium/Low] |
      | Affected Systems | [Count] | [High/Medium/Low] |
      | Patch Availability | [Yes/No] | [High/Medium/Low] |
      | Compensating Controls | [Yes/No] | [High/Medium/Low] |
      
      **Final Priority:** [EMERGENCY/URGENT/STANDARD/LOW]
      
      ---
      
      ## Action Items
      
      **Immediate (Next 24 Hours):**
      - [ ] [Action 1]
      - [ ] [Action 2]
      
      **Short-Term (This Week):**
      - [ ] [Action 3]
      - [ ] [Action 4]
      
      **Long-Term (This Month):**
      - [ ] [Action 5]
      
      ---
      
      ## Sign-Off
      
      **Security Team Lead:** ________________  Date: ______
      **IT Operations Lead:** ________________  Date: ______
      **Risk Accept (if applicable):** ________________  Date: ______
      
      ---
      
      ## Confidence Metrics
      
      **Consensus Level:** {{severity_consensus.agreement}}%
      **Provider Assessments:** [List individual assessments]
      **Intelligence Sources:** [List sources consulted]
      **Assessment Duration:** {{execution.duration}}
      
      ---
      
      **Note:** Severity determined through unanimous consensus of 3 AI providers
      to ensure high-confidence prioritization before resource allocation.

# Usage:
#
# ./mcp-cli --workflow vulnerability_assessment \
#   --server brave-search \
#   --input-data '{
#     "cve": "CVE-2024-1234",
#     "software": "Apache Tomcat 9.0.x",
#     "type": "Remote Code Execution",
#     "affected_systems": 47,
#     "cvss": "9.8 (Critical)"
#   }'
#
# Or from vulnerability scanner:
# curl https://scanner/api/vulnerability/12345 | \
#   ./mcp-cli --workflow vulnerability_assessment
#
# Business Value:
# - Unanimous consensus prevents under-prioritizing critical vulns
# - Consistent CVSS interpretation across security team
# - Automated exploit intelligence gathering
# - Clear remediation timelines
# - Resource allocation justification
#
# ROI Calculation:
# - Manual assessment: 2 hours × $150/hour = $300
# - Automated consensus: 2 minutes × $0.03 = $0.03
# - Savings: $299.97 per vulnerability (99.99%)
# - 50 vulns/month = $14,998.50 monthly savings
# - Annual savings: $179,982
#
# Risk Reduction:
# - Unanimous consensus ensures critical vulns not missed
# - Prevents $1M+ breach from unpatched critical vulnerability
# - ROI: Infinite if prevents one breach
