$schema: "workflow/v2.0"
name: soar_alert_enrichment
version: 2.0.0
description: SOAR alert enrichment with consensus-based triage to reduce false positives

execution:
  provider: anthropic
  model: claude-sonnet-4
  temperature: 0.3
  servers: [brave-search]  # For threat intelligence lookups

steps:
  # Step 1: Parse and extract alert details
  - name: parse_alert
    run: |
      Parse this security alert and extract key information:
      
      {{input}}
      
      Extract:
      - Alert type/name
      - Severity (as reported)
      - Source IP address(es)
      - Destination IP address(es)
      - Affected assets
      - Indicators of Compromise (IOCs)
      - Timestamp
      - Alert description
      
      Return structured JSON with all extracted fields.

  # Step 2: Multi-provider threat assessment
  - name: threat_assessment
    needs: [parse_alert]
    consensus:
      prompt: |
        Assess this security alert for threat level:
        
        {{parse_alert}}
        
        Analyze:
        
        **1. True Positive Likelihood:**
        - Is this likely a real threat or false positive?
        - What evidence supports this?
        - Confidence level (HIGH/MEDIUM/LOW)
        
        **2. MITRE ATT&CK Mapping:**
        - Which MITRE ATT&CK tactics/techniques apply?
        - Example: TA0001 (Initial Access), T1190 (Exploit Public-Facing Application)
        
        **3. Threat Actor Profile:**
        - Known threat actor patterns?
        - APT group indicators?
        - Commodity malware vs targeted attack?
        
        **4. Severity Assessment:**
        - CRITICAL: Active compromise, data exfiltration
        - HIGH: Exploitation attempt, command & control
        - MEDIUM: Reconnaissance, suspicious activity
        - LOW: Policy violation, false positive likely
        
        **5. Immediate Threat:**
        - Is this an active ongoing attack?
        - Is immediate response required?
        - Can this wait for business hours?
        
        Provide assessment with confidence level and reasoning.
      executions:
        - provider: anthropic
          model: claude-sonnet-4
          temperature: 0.2
        - provider: openai
          model: gpt-4o
          temperature: 0.2
        - provider: deepseek
          model: deepseek-chat
          temperature: 0.2
      require: 2/3  # At least 2 must agree on severity
      timeout: 90s

  # Step 3: Threat intelligence enrichment
  - name: threat_intel
    needs: [parse_alert, threat_assessment]
    run: |
      Gather threat intelligence for indicators:
      
      Alert Details:
      {{parse_alert}}
      
      Assessment:
      {{threat_assessment}}
      
      For each IP address, domain, or hash in the alert:
      
      **Search for:**
      1. Known malicious infrastructure
      2. Threat intelligence reports
      3. Recent security advisories
      4. Similar attack patterns
      
      **Provide:**
      - Reputation score/status
      - Associated threat campaigns
      - First seen / last seen dates
      - Geographic origin
      - Related IOCs
      
      Summarize findings and threat context.

  # Step 4: Generate containment recommendations
  - name: containment_plan
    needs: [threat_assessment, threat_intel]
    run: |
      Generate containment and response recommendations:
      
      Alert: {{parse_alert}}
      Threat Assessment: {{threat_assessment}}
      Intelligence: {{threat_intel}}
      
      Provide:
      
      **IMMEDIATE ACTIONS (Next 5 minutes):**
      1. [First containment action]
         - Command/procedure
         - Expected outcome
         - Risk if not taken
      2. [Second action if needed]
      
      **SHORT-TERM RESPONSE (Next 1 hour):**
      1. Investigation steps
      2. Evidence collection
      3. Scope determination
      
      **LONG-TERM REMEDIATION:**
      1. Root cause fix
      2. Detection improvements
      3. Prevention measures
      
      **ESCALATION CRITERIA:**
      - Escalate if: [conditions]
      - Escalate to: [team/person]
      - Timeframe: [when]

  # Step 5: Generate SOAR playbook execution plan
  - name: soar_playbook
    needs: [containment_plan]
    run: |
      Generate comprehensive SOAR enrichment report:
      
      # SOAR Alert Enrichment Report
      
      **Alert ID:** {{workflow.execution_id}}
      **Timestamp:** {{execution.timestamp}}
      **Workflow:** {{workflow.name}} v{{workflow.version}}
      
      ---
      
      ## Alert Summary
      
      {{parse_alert}}
      
      ---
      
      ## Consensus Threat Assessment
      
      {{threat_assessment}}
      
      **Consensus Level:** [Extract from assessment]
      **Recommended Severity:** [Extract consensus severity]
      **True Positive Confidence:** [Extract consensus confidence]
      
      ---
      
      ## Threat Intelligence Context
      
      {{threat_intel}}
      
      ---
      
      ## Recommended Actions
      
      {{containment_plan}}
      
      ---
      
      ## Triage Decision
      
      Based on consensus assessment:
      
      **[ ] CRITICAL - Immediate Response Required**
      - Page on-call security team NOW
      - Begin containment within 5 minutes
      - Executive notification required
      
      **[ ] HIGH - Urgent Response (Within 1 Hour)**
      - Notify security team
      - Begin investigation immediately
      - Schedule containment during business hours
      
      **[ ] MEDIUM - Standard Response (Within 24 Hours)**
      - Add to investigation queue
      - Review during business hours
      - No immediate action required
      
      **[ ] LOW - False Positive Likely**
      - Review alert rules
      - Consider tuning/suppression
      - Document as false positive if confirmed
      
      ---
      
      ## MITRE ATT&CK Mapping
      
      [Extract from threat_assessment]
      
      ---
      
      ## Next Steps
      
      1. **Immediate:** [From containment_plan]
      2. **Investigation:** [Collection steps]
      3. **Remediation:** [Long-term fixes]
      4. **Prevention:** [Future detection]
      
      ---
      
      ## Confidence & Quality Metrics
      
      **Consensus Agreement:** {{threat_assessment.agreement}}%
      **Provider Votes:** [List provider assessments]
      **Enrichment Sources:** [List intel sources used]
      **Execution Time:** {{execution.duration}}
      
      ---
      
      **Note:** This alert was enriched using multi-provider consensus 
      to reduce false positives. 2 of 3 AI systems must agree on 
      severity before escalation.

# Usage:
#
# ./mcp-cli --workflow soar_alert_enrichment \
#   --server brave-search \
#   --input-data "$(cat security_alert.json)"
#
# Or from SIEM:
# curl https://siem/api/alert/12345 | \
#   ./mcp-cli --workflow soar_alert_enrichment
#
# Business Value:
# - 500× faster triage than manual analysis
# - Consensus validation reduces false positive escalations
# - Automatic threat intelligence enrichment
# - Consistent MITRE ATT&CK mapping
# - Immediate actionable recommendations
#
# ROI Calculation:
# - Manual triage: 30 minutes × $100/hour = $50
# - Automated: 90 seconds × $0.03 = $0.03
# - Savings: $49.97 per alert (99.94%)
# - 100 alerts/day = $4,997/day savings
# - Annual savings: $1.82M
