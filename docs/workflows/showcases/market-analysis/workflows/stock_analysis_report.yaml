$schema: "workflow/v2.0"
name: stock_analysis_report
version: 2.0.0
description: Multi-factor stock analysis with MCP servers for real-time financial data

execution:
  provider: anthropic
  model: claude-sonnet-4
  temperature: 0.3
  servers: [brave-search]

steps:
  # Step 1: Gather company information
  - name: company_overview
    run: |
      Gather comprehensive company information:
      
      Company/Ticker: {{input}}
      
      **Company Overview:**
      
      **Basic Information:**
      - Company name: [Full legal name]
      - Ticker symbol: [Exchange:TICKER]
      - Industry: [Primary industry]
      - Sector: [Broader sector]
      - Market cap: $[amount]
      - Headquarters: [City, State/Country]
      
      **Business Description:**
      - Primary business: [What they do]
      - Products/Services: [Key offerings]
      - Revenue model: [How they make money]
      - Target customers: [Who they serve]
      
      **Key People:**
      - CEO: [Name]
      - CFO: [Name]
      - Founded: [Year]
      - Employees: [Count]
      
      **Stock Information:**
      - Exchange: [NYSE/NASDAQ/etc]
      - Current price: $[price]
      - 52-week range: $[low] - $[high]
      - Average volume: [shares]
      
      Use web search to find latest company information.

  # Step 2: Analyze financials
  - name: analyze_financials
    needs: [company_overview]
    run: |
      Analyze financial performance:
      
      Company: {{company_overview}}
      
      **Financial Performance:**
      
      **Revenue:**
      - Latest quarter: $[amount]
      - YoY growth: [X]%
      - Annual revenue: $[amount]
      - Revenue trend: [Growing/Stable/Declining]
      
      **Profitability:**
      - Gross margin: [X]%
      - Operating margin: [X]%
      - Net margin: [X]%
      - Profitability trend: [Improving/Stable/Declining]
      
      **Earnings:**
      - EPS (TTM): $[amount]
      - EPS growth: [X]%
      - Next quarter estimate: $[amount]
      - Beat/miss history: [Track record]
      
      **Cash Flow:**
      - Operating cash flow: $[amount]
      - Free cash flow: $[amount]
      - FCF margin: [X]%
      - Cash position: $[amount]
      
      **Balance Sheet:**
      - Total assets: $[amount]
      - Total debt: $[amount]
      - Debt/Equity: [ratio]
      - Current ratio: [ratio]
      
      **Financial Health:**
      - Strong points: [List]
      - Concerns: [List]
      - Overall grade: [A/B/C/D/F]
      
      Use web search for latest financial data and earnings reports.

  # Step 3: Valuation analysis
  - name: valuation_analysis
    needs: [analyze_financials]
    run: |
      Analyze stock valuation:
      
      Financials: {{analyze_financials}}
      Company: {{company_overview}}
      
      **Valuation Metrics:**
      
      **Price Multiples:**
      - P/E Ratio: [X]× (Industry avg: [Y]×)
      - P/E vs growth (PEG): [ratio]
      - Price/Sales: [X]× (Industry avg: [Y]×)
      - Price/Book: [X]× (Industry avg: [Y]×)
      - EV/EBITDA: [X]× (Industry avg: [Y]×)
      
      **Valuation Assessment:**
      | Metric | Company | Industry | Sector | Assessment |
      |--------|---------|----------|--------|------------|
      | P/E | [X] | [Y] | [Z] | [Overvalued/Fair/Undervalued] |
      | P/S | [X] | [Y] | [Z] | [Assessment] |
      | P/B | [X] | [Y] | [Z] | [Assessment] |
      
      **Relative Valuation:**
      - vs Industry: [Premium/Discount] of [X]%
      - vs Sector: [Premium/Discount] of [X]%
      - Justification: [Why premium/discount makes sense or not]
      
      **Intrinsic Value Estimates:**
      - DCF valuation: $[price] (assumptions: [list key assumptions])
      - PE-based target: $[price] (using [X]× forward PE)
      - Analyst consensus: $[average target]
      - Valuation range: $[low] - $[high]
      
      **Valuation Conclusion:**
      - Current price: $[price]
      - Fair value estimate: $[price]
      - Upside/Downside: [X]%
      - Valuation verdict: [Overvalued/Fairly valued/Undervalued]
      
      Use web search for comparable company data and analyst estimates.

  # Step 4: Growth analysis
  - name: growth_analysis
    needs: [analyze_financials]
    run: |
      Analyze growth prospects:
      
      Financials: {{analyze_financials}}
      Company: {{company_overview}}
      
      **Growth Analysis:**
      
      **Historical Growth:**
      - Revenue CAGR (5yr): [X]%
      - EPS CAGR (5yr): [X]%
      - Growth consistency: [Consistent/Variable]
      
      **Forward Growth:**
      - Revenue growth forecast: [X]% next year, [Y]% 3yr
      - EPS growth forecast: [X]% next year, [Y]% 3yr
      - Analyst consensus: [estimate]
      
      **Growth Drivers:**
      1. [Driver]: [How it contributes to growth]
      2. [Driver]: [How it contributes to growth]
      3. [Driver]: [How it contributes to growth]
      
      **Growth Risks:**
      1. [Risk]: [How it could hurt growth]
      2. [Risk]: [How it could hurt growth]
      
      **Market Opportunity:**
      - TAM (Total addressable market): $[amount]
      - Current market share: [X]%
      - Growth runway: [Large/Medium/Limited]
      
      **Competitive Position:**
      - Market position: [Leader/Challenger/Follower]
      - Competitive advantages: [List]
      - Threats: [List]
      
      **Growth Quality:**
      - Organic vs acquisition: [breakdown]
      - Sustainable: [Yes/No and why]
      - Quality grade: [A/B/C/D/F]
      
      Use web search for growth forecasts and market data.

  # Step 5: Technical analysis
  - name: technical_analysis
    needs: [company_overview]
    run: |
      Perform technical analysis:
      
      Stock: {{company_overview}}
      
      **Technical Analysis:**
      
      **Price Action:**
      - Current price: $[price]
      - 50-day MA: $[price]
      - 200-day MA: $[price]
      - Price vs 50-day: [Above/Below by X]%
      - Price vs 200-day: [Above/Below by Y]%
      
      **Trend:**
      - Short-term trend: [Up/Down/Sideways]
      - Medium-term trend: [Up/Down/Sideways]
      - Long-term trend: [Up/Down/Sideways]
      - Overall trend: [Bullish/Bearish/Neutral]
      
      **Support & Resistance:**
      - Key support: $[price levels]
      - Key resistance: $[price levels]
      - Next target up: $[price]
      - Next target down: $[price]
      
      **Momentum Indicators:**
      - RSI (14-day): [value] - [Overbought/Neutral/Oversold]
      - MACD: [Signal] - [Bullish/Bearish]
      - Volume trend: [Increasing/Decreasing/Normal]
      
      **Chart Patterns:**
      - Pattern: [If any notable pattern]
      - Interpretation: [What it suggests]
      
      **Technical Outlook:**
      - Short-term (1-3 months): [Bullish/Neutral/Bearish]
      - Medium-term (3-12 months): [Bullish/Neutral/Bearish]
      - Key levels to watch: [Prices]
      
      Use web search for current price data and technical indicators.

  # Step 6: Risk assessment
  - name: risk_assessment
    needs: [analyze_financials, growth_analysis, valuation_analysis]
    run: |
      Assess investment risks:
      
      Financials: {{analyze_financials}}
      Growth: {{growth_analysis}}
      Valuation: {{valuation_analysis}}
      
      **Risk Assessment:**
      
      **Business Risks:**
      1. **[Risk Category]**
         - Description: [What the risk is]
         - Impact: [High/Medium/Low]
         - Probability: [High/Medium/Low]
         - Mitigation: [How company addresses it]
      
      **Financial Risks:**
      - Debt level: [High/Medium/Low concern]
      - Cash position: [Strong/Adequate/Weak]
      - Profitability: [Stable/Variable/Declining]
      - Balance sheet strength: [Strong/Fair/Weak]
      
      **Market Risks:**
      - Economic sensitivity: [Cyclical/Defensive]
      - Competition: [Intense/Moderate/Limited]
      - Regulatory risks: [High/Medium/Low]
      - Technology disruption: [High/Medium/Low threat]
      
      **Valuation Risks:**
      - Valuation level: [Rich/Fair/Cheap]
      - Multiple compression risk: [High/Medium/Low]
      - Earnings disappointment risk: [High/Medium/Low]
      
      **Execution Risks:**
      - Management quality: [Strong/Fair/Weak]
      - Strategy clarity: [Clear/Unclear]
      - Execution track record: [Good/Mixed/Poor]
      
      **Overall Risk Profile:**
      - Risk level: [Low/Medium/High]
      - Risk-adjusted return: [Attractive/Fair/Unattractive]
      - Suitable for: [Growth investors/Value investors/Conservative/Speculative]
      
      **Red Flags:**
      - [Flag 1]: [Description]
      - [Flag 2]: [Description]
      
      **Positive Factors:**
      - [Factor 1]: [Description]
      - [Factor 2]: [Description]

  # Step 7: Generate investment thesis
  - name: investment_thesis
    needs: [valuation_analysis, growth_analysis, risk_assessment]
    run: |
      Generate comprehensive investment thesis:
      
      Valuation: {{valuation_analysis}}
      Growth: {{growth_analysis}}
      Risk: {{risk_assessment}}
      Financials: {{analyze_financials}}
      
      **Investment Thesis:**
      
      **Bull Case:**
      
      **Why to Buy:**
      1. [Reason]: [Detailed explanation]
      2. [Reason]: [Detailed explanation]
      3. [Reason]: [Detailed explanation]
      
      **Upside Scenario:**
      - Best case target: $[price] ([X]% upside)
      - Triggers: [What would drive this]
      - Probability: [X]%
      
      **Bear Case:**
      
      **Why to Avoid:**
      1. [Concern]: [Detailed explanation]
      2. [Concern]: [Detailed explanation]
      3. [Concern]: [Detailed explanation]
      
      **Downside Scenario:**
      - Worst case target: $[price] ([X]% downside)
      - Triggers: [What would cause this]
      - Probability: [X]%
      
      **Base Case:**
      
      **Most Likely Outcome:**
      - Target price: $[price]
      - Expected return: [X]%
      - Timeline: [X months]
      - Probability: [X]%
      
      **Investment Recommendation:**
      - Rating: [Strong Buy/Buy/Hold/Sell/Strong Sell]
      - Rationale: [One paragraph summary]
      - Timeframe: [Short/Medium/Long term]
      - Position size: [Large/Medium/Small/None]
      
      **Key Catalysts:**
      - Near-term: [What to watch]
      - Medium-term: [What to watch]
      - Long-term: [What to watch]
      
      **Price Targets:**
      - 12-month target: $[price]
      - Stop loss: $[price]
      - Take profit: $[price]

  # Step 8: Generate comprehensive report
  - name: stock_report
    needs: [investment_thesis, technical_analysis]
    run: |
      Generate comprehensive stock analysis report:
      
      # Stock Analysis Report: {{company_overview.ticker}}
      
      **Generated:** {{execution.timestamp}}
      **Workflow:** {{workflow.name}} v{{workflow.version}}
      
      ---
      
      ## Executive Summary
      
      **Company:** {{company_overview.name}}
      **Ticker:** {{company_overview.ticker}}
      **Current Price:** $[price]
      **Target Price:** $[price]
      
      **Recommendation:** [Strong Buy/Buy/Hold/Sell/Strong Sell]
      
      **Key Investment Highlights:**
      1. [Highlight #1]
      2. [Highlight #2]
      3. [Highlight #3]
      
      **Primary Risks:**
      1. [Risk #1]
      2. [Risk #2]
      
      ---
      
      ## Company Overview
      
      {{company_overview}}
      
      ---
      
      ## Financial Analysis
      
      {{analyze_financials}}
      
      ---
      
      ## Valuation Analysis
      
      {{valuation_analysis}}
      
      ---
      
      ## Growth Analysis
      
      {{growth_analysis}}
      
      ---
      
      ## Technical Analysis
      
      {{technical_analysis}}
      
      ---
      
      ## Risk Assessment
      
      {{risk_assessment}}
      
      ---
      
      ## Investment Thesis
      
      {{investment_thesis}}
      
      ---
      
      ## Conclusion
      
      **Investment Verdict:** [Summary recommendation]
      
      **For Investors Who:**
      - [Investor profile this suits]
      
      **Not Suitable For:**
      - [Investor profile this doesn't suit]
      
      **Next Steps:**
      1. [Action item]
      2. [Action item]
      
      ---
      
      ## Disclosures
      
      This analysis is for informational purposes only and does not constitute
      financial advice. Past performance does not guarantee future results.
      Always conduct your own due diligence and consult with a financial advisor.
      
      **Data Sources:** Public financial statements, company reports, market data,
      industry research. All data verified where possible.
      
      ---
      
      ## Business Value
      
      **Time Savings:**
      - Manual stock analysis: 8 hours
      - Automated workflow: 10 minutes
      - Savings: 7h 50min (98%)
      
      **Analysis Quality:**
      - Multi-factor comprehensive analysis
      - Systematic evaluation (no steps skipped)
      - Current data via web search
      - Balanced bull/bear perspectives

# Usage:
#
# Analyze stock:
# ./mcp-cli --workflow stock_analysis_report \
#   --server brave-search \
#   --input-data "AAPL"
#
# Compare multiple stocks:
# for ticker in AAPL MSFT GOOGL; do
#   ./mcp-cli --workflow stock_analysis_report \
#     --server brave-search \
#     --input-data "$ticker" > analysis_$ticker.md
# done
#
# Business Value:
# - 98% time savings (8 hours → 10 minutes)
# - Systematic multi-factor analysis
# - Step dependencies ensure completeness
# - Web search for current market data
# - Balanced investment perspective
#
# ROI Calculation:
# - Manual analysis: 8 hours × $200/hour = $1,600
# - Automated: 10 minutes × $0.10 = $0.10
# - Savings: $1,599.90 per stock (99.994%)
# - 10 stocks/month: $15,999/month = $191,988/year
#
# Use Cases:
# - Individual stock research
# - Portfolio analysis
# - Investment screening
# - Due diligence
# - Market opportunities
#
# Note: This provides analysis framework. Always verify data
# and conduct additional research before investment decisions.
